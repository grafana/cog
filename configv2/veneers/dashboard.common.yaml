# yaml-language-server: $schema=https://raw.githubusercontent.com/grafana/cog/main/schemas/veneers.json

language: all

package: dashboard

builders:
  # We don't want these builders at all
  - omit: { by_object: DataSourceRef }

  # overrides and transformations related
  - omit: { by_object: DashboardFieldConfigSourceOverrides }
  - omit: { by_object: MatcherConfig }
  - omit: { by_object: DynamicConfigValue }

  ##############
  # Dashboards #
  ##############

  # No need for builders for structs generated from a disjunction
  - omit: { generated_from_disjunction: true }

  - promote_options_to_constructor:
      by_object: Dashboard
      options: [title]

  # Rearrange things a bit
  - merge_into:
      source: FieldConfig
      destination: VizConfigSpec
      under_path: fieldConfig.defaults
      rename_options:
        color: colorScheme
        links: dataLinks
  - merge_into:
      source: FieldConfigSource
      destination: VizConfigSpec
      under_path: fieldConfig
  - merge_into:
      source: VizConfigSpec
      destination: VizConfigKind
      under_path: spec

  # Panels VizConfigSpec composability
  - compose_dashboard_panel:
      panel_builder_name: dashboard.VizConfigKind
      composed_builder_name: VizConfig
      plugin_discriminator_field: kind
      composition_map: # Builder â†’ assignment root path
        Options: "spec.options"
        FieldConfig: "spec.fieldConfig.defaults.custom"
      exclude_panel_options: [
        "spec",          # merged with another builder
        "defaults",      # merged with another builder
        "fieldConfig",   # merged with another builder
        "options",       # comes from a panel plugin
        "custom",        # comes from a panel plugin
        "pluginVersion", # TODO: check if it's relevant or not
        "filterable",    # TODO: check if it's relevant or not
        "writeable",     # TODO: check if it's relevant or not
      ]

options:
  # Append a single `element` value instead of a map of everything
  - duplicate:
      by_name: Dashboard.Elements
      as: withElement
  - map_to_append:
      by_name: Dashboard.withElement

  # Append a single override instead forcing to define all of them at once
  - duplicate:
      by_name: VizConfigKind.overrides
      as: withOverride
  - array_to_append:
      by_name: VizConfigKind.withOverride

  # Append a single transformation instead forcing to define all of them at once
  - duplicate:
      by_name: QueryGroupSpec.transformations
      as: withTransformation
  - array_to_append:
      by_name: QueryGroupSpec.withTransformation
