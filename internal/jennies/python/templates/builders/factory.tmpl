{{- define "factory" }}
{{- $builderPkg := "" }}
{{- if ne .Builder.Package .Factory.BuilderRef.ReferredPkg }}
{{- $builderPkg = (importModule (print .Factory.BuilderRef.ReferredPkg "_builder") "..builders" (.Factory.BuilderRef.ReferredPkg)) }}
{{- end }}
{{- with .Factory.Comments}}
"""
{{- range . }}
{{ . }}{{ end }}
"""
{{- end }}
def {{ .Factory.Name|formatFunctionName}}({{- template "factory_args" .Factory.Args }}) -> {{ if ne $builderPkg "" -}}{{ .Factory.BuilderRef|refToType|formatType }}{{ else }}{{ .Factory.BuilderRef.ReferredType|formatObjectName }}{{ end }}:
    builder = {{ if ne $builderPkg "" -}}{{ $builderPkg }}.{{- end -}}{{ .Factory.BuilderRef.ReferredType|formatObjectName }}()

{{- range $call := .Factory.OptionCalls }}
    builder.{{ $call.Name|formatFunctionName }}({{- range $i, $param := $call.Parameters }}{{- if gt $i 0 }}, {{ end }}{{ template "factory_parameter_value" (dict "Value" $param) -}}{{- end }})
{{- end }}

    return builder
{{ end }}

{{- define "factory_args" -}}
    {{- range $i, $arg := . }}{{- if gt $i 0 }}, {{ end }}{{ $arg.Name|formatIdentifier }}: {{ $arg.Type | formatType }}{{ end }}
{{- end -}}

{{- define "factory_parameter_value" }}
    {{- if not (eq .Value.Constant nil) -}}
        {{- formatValue .Value.Constant.Type .Value.Constant.Value }}
    {{- end }}
	{{- if not (eq .Value.Argument nil) -}}
		{{- .Value.Argument.Name|formatIdentifier -}}{{ if .Value.ForceBuild }}.build(){{ end }}
	{{- end -}}
    {{- with .Value.Factory -}}
        {{ .Ref.Factory|formatFunctionName }}({{ range $i, $arg := .Parameters }}{{- if gt $i 0 }}, {{ end }}{{ template "factory_parameter_value" (dict "Value" $arg)}}{{ end }})
    {{- end -}}
{{- end }}
